---

- name: delete logs folder
  local_action:
    module: file
    path: "../logs/"
    state: absent
  run_once: yes

- name: delete files folder
  local_action:
    module: file
    path: "../files/"
    state: absent
  run_once: yes

- name: create logs folder
  local_action:
    module: file
    path: "../logs/{{ inventory_hostname }}/"
    state: directory

- name: create files folder
  local_action:
    module: file
    path: "../files/"
    state: directory
  run_once: yes

- name: get files from 1st location
  find:
    age: -2h
    file_type: any
    paths: "{{path1}}{{ num }}{{path2}}{{ num }}"
  register: find_output

- debug:
    msg: "{{path1}}{{ num }}{{path2}}{{ num }}"
    verbosity: 2

- name: create files list
  set_fact:
    files: '{{ files + [item.path] }}'
  with_items: "{{ find_output.files}}"

- name: get files from 2nd location
  find:
    age: -2h
    file_type: any
    paths: "{{path3}}{{ num }}"
  register: find_output2

- debug:
    msg: "{{path3}}{{ num }}"
    verbosity: 2

- name: add to files list
  set_fact:
    files: '{{ files + [item.path] }}'
  with_items: "{{ find_output2.files}}"

- debug:
    verbosity: 2
    var: files

- name: fetch files
  fetch:
    src: "{{ item }}"
    dest: "../logs/{{ inventory_hostname }}/"
    flat: yes
    fail_on_missing: no
    validate_checksum: no
  register: fetch_output
  with_items: "{{ files }}"
  when: files|length > 0

- debug:
    verbosity: 2
    var: fetch_output

- name: create list of files copied
  set_fact:
    copies: '{{ copies + [item.dest] }}'
  with_items: "{{ fetch_output.results}}"

- debug:
    var: copies
    verbosity: 2

- name: write list of file per host
  local_action:
    module: lineinfile
    create: yes
    dest: "../files/{{ inventory_hostname }}"
    line: "{{ item }}"
  with_list: "{{copies}}"

